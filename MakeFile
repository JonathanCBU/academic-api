# Academic Data Collection API - Makefile
# Common development commands

.PHONY: help build run test clean migrate-up migrate-down migrate-create seed dev install-tools fmt lint vet docker-build docker-run backup import-schools

# Default target
.DEFAULT_GOAL := help

# Variables
BINARY_NAME=academic-api
BINARY_PATH=./bin/$(BINARY_NAME)
DB_PATH=./data/academic_data.db
MIGRATION_DIR=./migrations
GO=go
GOFLAGS=-v

## help: Display this help message
help:
	@echo "Academic Data Collection API - Available Commands:"
	@echo ""
	@echo "=== Development ==="
	@grep -E '^## (run|dev|test|check):' $(MAKEFILE_LIST) | sed -e 's/## /  /' | column -t -s ':'
	@echo ""
	@echo "=== Build ==="
	@grep -E '^## (build|clean):' $(MAKEFILE_LIST) | sed -e 's/## /  /' | column -t -s ':'
	@echo ""
	@echo "=== Database ==="
	@grep -E '^## (migrate|seed|backup|restore|import|clean-db):' $(MAKEFILE_LIST) | sed -e 's/## /  /' | column -t -s ':'
	@echo ""
	@echo "=== Docker ==="
	@grep -E '^## (docker|compose):' $(MAKEFILE_LIST) | sed -e 's/## /  /' | column -t -s ':'
	@echo ""
	@echo "=== Tools ==="
	@grep -E '^## (install-tools|fmt|lint|vet|deps|setup|stats):' $(MAKEFILE_LIST) | sed -e 's/## /  /' | column -t -s ':'
	@echo ""
	@echo "=== Scrapers ==="
	@grep -E '^## (scraper):' $(MAKEFILE_LIST) | sed -e 's/## /  /' | column -t -s ':'

## build: Build the server binary
build:
	@echo "Building server..."
	@mkdir -p bin
	$(GO) build $(GOFLAGS) -o $(BINARY_PATH) ./cmd/server
	@echo "Binary created at $(BINARY_PATH)"

## build-migrate: Build the migration tool
build-migrate:
	@echo "Building migration tool..."
	@mkdir -p bin
	$(GO) build $(GOFLAGS) -o ./bin/migrate ./cmd/migrate
	@echo "Migration tool created at ./bin/migrate"

## build-all: Build all binaries
build-all: build build-migrate
	@echo "All binaries built successfully"

## run: Run the API server
run:
	@echo "Starting API server..."
	$(GO) run ./cmd/server/main.go

## dev: Run server with hot reload (requires air)
dev:
	@echo "Starting development server with hot reload..."
	@if command -v air > /dev/null; then \
		air; \
	else \
		echo "Error: 'air' not installed. Run 'make install-tools' first"; \
		exit 1; \
	fi

## test: Run all tests
test:
	@echo "Running tests..."
	$(GO) test -v ./...

## test-coverage: Run tests with coverage report
test-coverage:
	@echo "Running tests with coverage..."
	$(GO) test -v -cover -coverprofile=coverage.out ./...
	$(GO) tool cover -html=coverage.out -o coverage.html
	@echo "Coverage report generated at coverage.html"

## test-integration: Run integration tests only
test-integration:
	@echo "Running integration tests..."
	$(GO) test -v -tags=integration ./tests/integration/...

## clean: Remove build artifacts and temporary files
clean:
	@echo "Cleaning up..."
	@rm -rf bin/
	@rm -f coverage.out coverage.html
	@rm -f *.log
	@echo "Cleanup complete"

## clean-db: Remove database file (WARNING: deletes all data)
clean-db:
	@echo "WARNING: This will delete the database file!"
	@read -p "Are you sure? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		rm -f $(DB_PATH); \
		rm -f $(DB_PATH)-shm; \
		rm -f $(DB_PATH)-wal; \
		echo "Database deleted"; \
	else \
		echo "Cancelled"; \
	fi

## migrate-up: Run all pending migrations
migrate-up:
	@echo "Running migrations..."
	@mkdir -p data
	@if [ -f ./bin/migrate ]; then \
		./bin/migrate up; \
	else \
		$(GO) run ./cmd/migrate/main.go up; \
	fi

## migrate-down: Rollback the last migration
migrate-down:
	@echo "Rolling back last migration..."
	@if [ -f ./bin/migrate ]; then \
		./bin/migrate down; \
	else \
		$(GO) run ./cmd/migrate/main.go down; \
	fi

## migrate-reset: Rollback all migrations and re-run them
migrate-reset: migrate-down-all migrate-up
	@echo "Database reset complete"

## migrate-down-all: Rollback all migrations
migrate-down-all:
	@echo "Rolling back all migrations..."
	@if [ -f ./bin/migrate ]; then \
		./bin/migrate down-all; \
	else \
		$(GO) run ./cmd/migrate/main.go down-all; \
	fi

## migrate-create: Create a new migration file (usage: make migrate-create NAME=add_new_field)
migrate-create:
	@if [ -z "$(NAME)" ]; then \
		echo "Error: NAME is required. Usage: make migrate-create NAME=add_new_field"; \
		exit 1; \
	fi
	@TIMESTAMP=$$(date +%s); \
	UP_FILE="$(MIGRATION_DIR)/$${TIMESTAMP}_$(NAME).up.sql"; \
	DOWN_FILE="$(MIGRATION_DIR)/$${TIMESTAMP}_$(NAME).down.sql"; \
	echo "-- Migration: $(NAME)" > $$UP_FILE; \
	echo "-- Created: $$(date)" >> $$UP_FILE; \
	echo "" >> $$UP_FILE; \
	echo "-- Add your UP migration here" >> $$UP_FILE; \
	echo "" >> $$UP_FILE; \
	echo "-- Migration: $(NAME)" > $$DOWN_FILE; \
	echo "-- Created: $$(date)" >> $$DOWN_FILE; \
	echo "" >> $$DOWN_FILE; \
	echo "-- Add your DOWN migration here" >> $$DOWN_FILE; \
	echo "" >> $$DOWN_FILE; \
	echo "Created migration files:"; \
	echo "  $$UP_FILE"; \
	echo "  $$DOWN_FILE"

## seed: Seed database with initial data
seed:
	@echo "Seeding database..."
	$(GO) run ./cmd/seed/main.go

## import-schools: Import schools from CSV file (usage: make import-schools FILE=data/schools.csv)
import-schools:
	@if [ -z "$(FILE)" ]; then \
		echo "Error: FILE is required. Usage: make import-schools FILE=data/schools.csv"; \
		exit 1; \
	fi
	@if [ ! -f "$(FILE)" ]; then \
		echo "Error: File '$(FILE)' not found"; \
		exit 1; \
	fi
	@echo "Importing schools from $(FILE)..."
	$(GO) run ./tools/import/csv_importer.go --file=$(FILE)

## backup: Create a backup of the database
backup:
	@echo "Creating database backup..."
	@mkdir -p backups
	@BACKUP_FILE="backups/academic_data_$$(date +%Y%m%d_%H%M%S).db"; \
	cp $(DB_PATH) $$BACKUP_FILE; \
	echo "Backup created at $$BACKUP_FILE"

## restore: Restore database from backup (usage: make restore FILE=backups/academic_data_20241115_143000.db)
restore:
	@if [ -z "$(FILE)" ]; then \
		echo "Error: FILE is required. Usage: make restore FILE=backups/academic_data_20241115_143000.db"; \
		exit 1; \
	fi
	@if [ ! -f "$(FILE)" ]; then \
		echo "Error: Backup file '$(FILE)' not found"; \
		exit 1; \
	fi
	@echo "Restoring database from $(FILE)..."
	@cp $(FILE) $(DB_PATH)
	@echo "Database restored successfully"

## install-tools: Install development tools (air for hot reload, golangci-lint, etc.)
install-tools:
	@echo "Installing development tools..."
	@echo "Installing air (hot reload)..."
	$(GO) install github.com/air-verse/air@latest
	@echo "Installing golangci-lint (linter)..."
	$(GO) install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	@echo "Installing golang-migrate (migration tool)..."
	$(GO) install -tags 'sqlite3' github.com/golang-migrate/migrate/v4/cmd/migrate@latest
	@echo "All tools installed successfully"

## fmt: Format Go code
fmt:
	@echo "Formatting code..."
	$(GO) fmt ./...

## lint: Run linter
lint:
	@echo "Running linter..."
	@if command -v golangci-lint > /dev/null; then \
		golangci-lint run ./...; \
	else \
		echo "Error: golangci-lint not installed. Run 'make install-tools'"; \
		exit 1; \
	fi

## vet: Run go vet
vet:
	@echo "Running go vet..."
	$(GO) vet ./...

## check: Run all checks (fmt, vet, lint, test)
check: fmt vet lint test
	@echo "All checks passed!"

## deps: Download and tidy dependencies
deps:
	@echo "Downloading dependencies..."
	$(GO) mod download
	$(GO) mod tidy
	@echo "Dependencies updated"

## setup: Initial project setup (install tools, run migrations, seed data)
setup: install-tools deps migrate-up
	@echo ""
	@echo "=========================================="
	@echo "Setup complete! Next steps:"
	@echo "1. Copy .env.example to .env and configure"
	@echo "2. Import your schools: make import-schools FILE=data/schools.csv"
	@echo "3. Start the server: make run"
	@echo "=========================================="

## docker-build: Build Docker image
docker-build:
	@echo "Building Docker image..."
	docker build -t $(BINARY_NAME):latest .

## docker-run: Run Docker container (standalone)
docker-run:
	@echo "Running Docker container..."
	docker run -d -p 8080:8080 -v $(PWD)/data:/app/data --name $(BINARY_NAME) $(BINARY_NAME):latest

## docker-stop: Stop Docker container
docker-stop:
	@echo "Stopping Docker container..."
	docker stop $(BINARY_NAME) || true
	docker rm $(BINARY_NAME) || true

## docker-logs: View Docker container logs
docker-logs:
	@echo "Viewing Docker logs..."
	docker logs -f $(BINARY_NAME)

## docker-shell: Open shell in running container
docker-shell:
	@echo "Opening shell in container..."
	docker exec -it $(BINARY_NAME) sh

## compose-up: Start all services with docker-compose
compose-up:
	@echo "Starting services with docker-compose..."
	docker-compose up -d

## compose-up-build: Build and start all services
compose-up-build:
	@echo "Building and starting services..."
	docker-compose up -d --build

## compose-down: Stop all docker-compose services
compose-down:
	@echo "Stopping docker-compose services..."
	docker-compose down

## compose-logs: View docker-compose logs
compose-logs:
	@echo "Viewing docker-compose logs..."
	docker-compose logs -f

## compose-restart: Restart docker-compose services
compose-restart:
	@echo "Restarting services..."
	docker-compose restart

## compose-ps: Show status of docker-compose services
compose-ps:
	@echo "Docker-compose services status:"
	docker-compose ps

## compose-prod: Start services with production profile (includes nginx)
compose-prod:
	@echo "Starting production services..."
	docker-compose --profile production up -d

## compose-prod-build: Build and start production services
compose-prod-build:
	@echo "Building and starting production services..."
	docker-compose --profile production up -d --build

## docker-clean: Remove all containers and images
docker-clean: docker-stop
	@echo "Cleaning Docker resources..."
	docker-compose down -v
	docker rmi $(BINARY_NAME):latest || true
	@echo "Docker cleanup complete"

## scraper-ca: Run California scraper
scraper-ca:
	@echo "Running California scraper..."
	$(GO) run ./scrapers/california/scraper.go

## scraper-tx: Run Texas scraper
scraper-tx:
	@echo "Running Texas scraper..."
	$(GO) run ./scrapers/texas/scraper.go

## scraper-all: Run all state scrapers
scraper-all:
	@echo "Running all scrapers..."
	@for dir in ./scrapers/*/; do \
		if [ -f "$$dir/scraper.go" ]; then \
			echo "Running scraper in $$dir..."; \
			$(GO) run $$dir/scraper.go || echo "Failed: $$dir"; \
		fi \
	done

## api-docs: Generate API documentation
api-docs:
	@echo "Generating API documentation..."
	@echo "Documentation available at docs/api.md"

## stats: Show project statistics
stats:
	@echo "Project Statistics:"
	@echo "===================="
	@echo "Go files: $$(find . -name '*.go' | wc -l)"
	@echo "Lines of code: $$(find . -name '*.go' -exec cat {} \; | wc -l)"
	@echo "Test files: $$(find . -name '*_test.go' | wc -l)"
	@echo "Migrations: $$(ls -1 $(MIGRATION_DIR)/*.up.sql 2>/dev/null | wc -l)"
	@if [ -f $(DB_PATH) ]; then \
		echo "Database size: $$(du -h $(DB_PATH) | cut -f1)"; \
	fi
