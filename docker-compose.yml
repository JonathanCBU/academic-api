# =============================================================================
# docker-compose.yml - Development and Production Setup
# =============================================================================

version: '3.8'

services:
  # Main API Service
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: academic-api
    ports:
      - "8080:8080"
    volumes:
      # Mount data directory for persistence
      - ./data:/app/data
      # Mount migrations for development
      - ./migrations:/app/migrations
    environment:
      - DB_PATH=/app/data/academic_data.db
      - PORT=8080
      - ENV=development
      - LOG_LEVEL=debug
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Optional: Nginx reverse proxy (for production)
  nginx:
    image: nginx:alpine
    container_name: academic-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - api
    restart: unless-stopped
    profiles:
      - production

# Volumes for data persistence
volumes:
  data:
    driver: local

# Networks
networks:
  default:
    name: academic-network

---
# =============================================================================
# .dockerignore - Files to exclude from Docker build
# =============================================================================

# Git
.git
.gitignore
.gitattributes

# Documentation
README.md
docs/
*.md

# Development files
.env
.env.local
.env.*.local

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# OS files
.DS_Store
Thumbs.db

# Build artifacts
bin/
*.exe
*.dll
*.so
*.dylib

# Test files
*.test
*.out
coverage.out
coverage.html

# Data files (will be mounted as volume)
data/
backups/
*.db
*.db-shm
*.db-wal

# Logs
*.log
logs/

# Temporary files
tmp/
temp/

# Dependencies (will be downloaded in container)
vendor/

# CI/CD
.github/
.gitlab-ci.yml
.travis.yml

# Docker files (avoid recursive copy)
Dockerfile*
docker-compose*.yml
.dockerignore

# Scripts
scripts/
tools/import/
tools/export/

# Scrapers (typically run separately)
scrapers/

# Test fixtures
tests/fixtures/

---
# =============================================================================
# nginx.conf - Nginx Reverse Proxy Configuration (Optional)
# =============================================================================

events {
    worker_connections 1024;
}

http {
    upstream api {
        server api:8080;
    }

    # Rate limiting
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

    server {
        listen 80;
        server_name localhost;

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;

        # Logging
        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;

        # API proxy
        location /api/ {
            limit_req zone=api_limit burst=20 nodelay;
            
            proxy_pass http://api;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;

            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Health check
        location /health {
            proxy_pass http://api/health;
            access_log off;
        }

        # Root
        location / {
            return 200 'Academic Data Collection API';
            add_header Content-Type text/plain;
        }
    }

    # HTTPS configuration (uncomment and configure with SSL certs)
    # server {
    #     listen 443 ssl http2;
    #     server_name localhost;
    #
    #     ssl_certificate /etc/nginx/ssl/cert.pem;
    #     ssl_certificate_key /etc/nginx/ssl/key.pem;
    #
    #     # SSL configuration
    #     ssl_protocols TLSv1.2 TLSv1.3;
    #     ssl_ciphers HIGH:!aNULL:!MD5;
    #     ssl_prefer_server_ciphers on;
    #
    #     # ... rest of config same as above
    # }
}
